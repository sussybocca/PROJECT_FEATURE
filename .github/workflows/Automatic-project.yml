name: Auto Generate Repo

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: npm install node-fetch@3

      - name: Generate Project with AI
        run: |
          mkdir -p engine
          cat > engine/generate.js << 'EOF'
          import fs from 'fs';
          import fetch from 'node-fetch';

          const languages = ['javascript','python','ruby','go','java','c','cpp','csharp','php','rust','swift'];

          function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

          const lang = pick(languages);
          const id = Date.now();
          const projectName = `project_${lang}_${id}`;
          fs.mkdirSync(projectName, { recursive: true });

          // AI Prompt
          const prompt = `
Generate a complete ${lang} project with a main file. 
It should be runnable, unique, and self-contained. 
Include comments explaining the code.
`;

          const apiKey = process.env.AI_API_KEY;

          const response = await fetch("https://api.openai.com/v1/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${apiKey}`
            },
            body: JSON.stringify({
              model: "text-davinci-003",
              prompt: prompt,
              max_tokens: 2000
            })
          });

          const data = await response.json();
          const code = data.choices[0].text.trim();

          const mainFile = lang === 'javascript' ? 'index.js' :
                           lang === 'python' ? 'main.py' :
                           'main.txt';

          fs.writeFileSync(`${projectName}/${mainFile}`, code);
          fs.writeFileSync(`${projectName}/README.md`, `# Auto Generated Project\nLanguage: ${lang}\nID: ${id}`);

          console.log(`Generated project: ${projectName}`);
          EOF

      - name: Run Generator
        run: node engine/generate.js
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}

      - name: Commit & Push
        run: |
          git config --global user.name "auto-bot"
          git config --global user.email "bot@example.com"
          git add .
          git commit -m "Auto-generated AI project $(date)" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
